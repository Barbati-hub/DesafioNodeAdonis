<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Desafio Node</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <h1 class="text-2xl font-bold text-center mb-6">Bem-vindo ao Sistema</h1>
        
        <!-- Error Message -->
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded text-center">
        </div>
        
        <div class="space-y-4">
            <a href="/auth/google" 
               id="googleLoginBtn"
               class="flex items-center justify-center w-full px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors">
                <img src="https://www.google.com/favicon.ico" alt="Google Logo" class="w-6 h-6 mr-2">
                <span id="googleBtnText">Entrar com Google</span>
            </a>
        </div>
    </div>

    <script>
        // Limpa todos os cookies da sessão
        function clearAllCookies() {
            document.cookie.split(';').forEach(function(c) {
                document.cookie = c.trim().split('=')[0] + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            });
        }

        // Função para mostrar mensagem de erro
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Função para desabilitar o botão
        function disableButton() {
            const btn = document.getElementById('googleLoginBtn');
            const btnText = document.getElementById('googleBtnText');
            btn.style.pointerEvents = 'none';
            btn.classList.add('opacity-50');
            btnText.textContent = 'Redirecionando...';
            return btn;
        }

        // Função para habilitar o botão
        function enableButton() {
            const btn = document.getElementById('googleLoginBtn');
            const btnText = document.getElementById('googleBtnText');
            btn.style.pointerEvents = '';
            btn.classList.remove('opacity-50');
            btnText.textContent = 'Entrar com Google';
        }

        // Verificar parâmetros na URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
            const error = urlParams.get('error');
            const errorMessages = {
                'missing_config': 'Erro de configuração do sistema. Por favor, contate o administrador.',
                'missing_code': 'Código de autorização não encontrado. Por favor, tente novamente.',
                'invalid_tokens': 'Tokens de autenticação inválidos. Por favor, tente novamente.',
                'invalid_payload': 'Dados de autenticação inválidos. Por favor, tente novamente.',
                'token_processing': 'Erro ao processar autenticação. Por favor, aguarde...',
                'auth_failed': 'Falha na autenticação. Por favor, tente novamente.'
            };
            
            const message = errorMessages[error] || 'Erro na autenticação. Por favor, tente novamente.';
            showError(message);
            
            // Limpar a URL após mostrar o erro
            if (window.history && window.history.replaceState) {
                window.history.replaceState({}, document.title, '/login');
            }

            // Se for erro de token, tentar novamente após 3 segundos
            if (error === 'token_processing') {
                const btn = disableButton();
                
                setTimeout(() => {
                    // Limpa todos os cookies antes de tentar novamente
                    clearAllCookies();
                    
                    // Força um pequeno delay antes do redirecionamento
                    setTimeout(() => {
                        window.location.href = '/auth/google';
                    }, 100);
                }, 2000);
            }
        }
        
        // Prevenir múltiplos cliques e limpar cookies antes do login
        document.getElementById('googleLoginBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const btn = disableButton();
            
            // Limpa cookies antes de iniciar nova autenticação
            clearAllCookies();
            
            // Pequeno delay antes do redirecionamento
            setTimeout(() => {
                window.location.href = this.href;
            }, 100);
            
            // Se não houver redirecionamento em 5 segundos, reabilitar o botão
            setTimeout(() => {
                if (document.body.contains(btn)) {
                    enableButton();
                }
            }, 5000);
        });
    </script>
</body>
</html> 